---
title: "The Impact of Credits, Revenue, and Audience Perception"
subtitle: "Box office Modeling"
---

```{r message=FALSE, warning=FALSE, include=FALSE}
library(httr)
library(jsonlite)
library(plotly)
library(dplyr)
library(tidyverse)
library(tidytext)
library(ggplot2)
library(knitr)
library(kableExtra)
library(car) 
library(MASS)
library(lubridate)
library(randomForest)
library(gridExtra)
library(broom)
library(tm)
library(textdata)
library(ggcorrplot)
library(patchwork)
library(htmltools)
```

```{r, include=FALSE}
knitr::opts_chunk$set(toc.depth = 1)
```

```{r message=FALSE, warning=FALSE, include=FALSE}
movie_genres <- read.csv("data/movie_genres.csv")

reviews <- read.csv("data/reviews.csv")

movies <- read.csv("data/movies_full.csv")

movies <- movies %>%
  rename(tmdb_rating = vote_average)

movies <- movies %>%
  mutate(
    num_production_companies = str_count(production_companies, ", ") + 1,
    num_cast = str_count(cast, ", ") + 1,
    num_genre = str_count(genre_ids, ", ") + 1,
    num_production_countries = str_count(production_countries, ", ") + 1,
    first_genre = sapply(strsplit(as.character(genre_ids), ",\\s*"), `[`, 1)
  )

movies <- movies %>%
  mutate(first_genre = as.integer(first_genre)) %>%
  left_join(movie_genres, by = c("first_genre" = "id")) %>%
  mutate(first_genre = name) %>%
  dplyr::select(-name)

movies_cleaned_box <- movies %>%
  filter(!is.na(revenue) & !is.na(budget) & revenue > 100 & budget > 100)

movies_cleaned_box$log_revenue <- log(movies_cleaned_box$revenue)

reviews_clean <- reviews %>%
  filter(!is.na(content))

clean_text <- function(text) {
  text <- iconv(text, from = "UTF-8", to = "UTF-8", sub = "")
  text <- tolower(text)                
  text <- gsub("[^a-z'\\s]", " ", text)        
  text <- removeWords(text, stopwords("en"))   
  text <- stripWhitespace(text)             
  return(text)
}

reviews_clean <- reviews_clean %>%
  mutate(review = map_chr(content, clean_text)) |> 
  dplyr::select(review, movie_id)

reviews_clean <- reviews_clean %>%
  filter(str_trim(review) != "")



afinn_lex <- get_sentiments("afinn")

review_sentiment <- reviews_clean %>%
  mutate(review_id = row_number()) %>%
  unnest_tokens(word, review) %>%
  inner_join(afinn_lex, by = "word") %>%
  group_by(review_id, movie_id) %>%
  summarise(sentiment_score = mean(value), .groups = "drop")

movie_sentiment <- review_sentiment %>%
  group_by(movie_id) %>%
  summarise(avg_sentiment = mean(sentiment_score), .groups = "drop")

movie_sentiment_full <- movie_sentiment %>%
  inner_join(movies_cleaned_box, by = c("movie_id" = "id"))


model1 <- lm(log_revenue ~ budget + I(budget^2) + num_production_companies + num_cast +  num_production_countries + num_genre + tmdb_rating + imdb_rating + first_genre, data = movie_sentiment_full)

model2 <- lm(log_revenue ~ budget + I(budget^2) + num_production_companies + num_cast +  num_production_countries + num_genre + tmdb_rating + imdb_rating + first_genre + avg_sentiment, data = movie_sentiment_full)

set.seed(370)
train_index <- sample(1:nrow(movie_sentiment_full), 0.8 * nrow(movie_sentiment_full))
train_data <- movie_sentiment_full[train_index,]
test_data <- movie_sentiment_full[-train_index,]

rf_model1 <- randomForest(revenue ~ budget + num_production_companies + num_cast +  num_production_countries + num_genre + tmdb_rating + imdb_rating + first_genre,
                         data=train_data, ntree=100, importance=TRUE)
rf_model2 <- randomForest(revenue ~ budget + num_production_companies + num_cast +  num_production_countries + num_genre + tmdb_rating + imdb_rating + first_genre + avg_sentiment,
                         data=train_data, ntree=100, importance=TRUE)

custom_stopwords <- c("s", "t", "m", "ll", "ve", "re", "em", "d", "movie", "film", "films", "one", "two", "even", "just", "well", "also", "good", "will", "really", "sci", "fi", "can", "much", "oz", "ian")

reviews_genre <- reviews_clean %>%
  inner_join(movies_cleaned_box, by = c("movie_id" = "id"))
  
word_counts <- reviews_genre %>%
  unnest_tokens(word, review) %>%
  filter(!word %in% custom_stopwords) %>%
  count(first_genre, word, sort = TRUE)

tfidf_words <- word_counts %>%
  filter(n >= 5) |> 
  bind_tf_idf(word, first_genre, n) %>%
  arrange(desc(tf_idf))

```

# 1. Anaysis {.tabset}

## Revenue

### Box office Model Comparison: With vs Without Sentiment Score

This interactive plot compares the predictive performance of two modeling approaches—**Linear Regression** and **Random Forest**—in estimating movie box office revenue. The layout consists of three side-by-side plots:

- **Linear Model** (Full dataset): Fitted vs Actual revenue  
- **Random Forest – Train Set**: Fitted vs Actual revenue  
- **Random Forest – Test Set**: Predicted vs Actual revenue  

All models are using budget, genre, rating, number of cast and production companies / countries.

Despite expectations, including audience sentiment did not noticeably improve model accuracy, suggesting that sentiment scores may not provide additional predictive value in this context.

A toggle button above the plots allows you to switch between models that include **audience sentiment scores** as a feature and those that do not.

```{r sentiment_model_comparison, echo=FALSE, message=FALSE, warning=FALSE}
max_val <- max(movie_sentiment_full$revenue, na.rm = TRUE)
baseline_line <- list(
  type = "line",
  x0 = 0, y0 = 0,
  x1 = max_val, y1 = max_val,
  line = list(color = "gray", dash = "dash")
)

build_trace <- function(df, label, color, visible = TRUE) {
  list(
    x = df$actual,
    y = df$fitted,
    type = "scatter",
    mode = "markers",
    name = label,
    text = paste("Actual:", round(df$actual), "<br>Fitted:", round(df$fitted)),
    hoverinfo = "text",
    marker = list(color = color),
    visible = visible
  )
}

lm_with <- movie_sentiment_full %>% mutate(actual = revenue, fitted = exp(model2$fitted.values))
lm_without <- movie_sentiment_full %>% mutate(actual = revenue, fitted = exp(model1$fitted.values))
rf_train_with <- train_data %>% mutate(actual = revenue, fitted = predict(rf_model2, newdata = train_data))
rf_train_without <- train_data %>% mutate(actual = revenue, fitted = predict(rf_model1, newdata = train_data))
rf_test_with <- test_data %>% mutate(actual = revenue, fitted = predict(rf_model2, newdata = test_data))
rf_test_without <- test_data %>% mutate(actual = revenue, fitted = predict(rf_model1, newdata = test_data))

lm_w  <- build_trace(lm_with, "Linear Regression", "#1f77b4")
lm_wo <- build_trace(lm_without, "Linear Regression", "#1f77b4", FALSE)

rf_train_w  <- build_trace(rf_train_with, "Random Forest Train", "#2ca02c")
rf_train_wo <- build_trace(rf_train_without, "Random Forest Train", "#2ca02c", FALSE)

rf_test_w  <- build_trace(rf_test_with, "Random Forest Test", "#d62728")
rf_test_wo <- build_trace(rf_test_without, "Random Forest Test", "#d62728", FALSE)

max_axis <- max(movie_sentiment_full$revenue, na.rm = TRUE)

lm_plot <- plot_ly() %>%
  add_trace(x = lm_w$x, y = lm_w$y, type = lm_w$type, mode = lm_w$mode,
            name = lm_w$name, text = lm_w$text, hoverinfo = lm_w$hoverinfo,
            marker = lm_w$marker, visible = lm_w$visible) %>%
  add_trace(x = lm_wo$x, y = lm_wo$y, type = lm_wo$type, mode = lm_wo$mode,
            name = lm_wo$name, text = lm_wo$text, hoverinfo = lm_wo$hoverinfo,
            marker = lm_wo$marker, visible = lm_wo$visible) %>%
  layout(title = "Linear Model", shapes = list(baseline_line),
         xaxis = list(title = "Actual Revenue", range = c(0, max_axis)),
         yaxis = list(title = "Fitted Revenue", range = c(0, max_axis)))

rf_train_plot <- plot_ly() %>%
  add_trace(x = rf_train_w$x, y = rf_train_w$y, type = rf_train_w$type, mode = rf_train_w$mode,
            name = rf_train_w$name, text = rf_train_w$text, hoverinfo = rf_train_w$hoverinfo,
            marker = rf_train_w$marker, visible = rf_train_w$visible) %>%
  add_trace(x = rf_train_wo$x, y = rf_train_wo$y, type = rf_train_wo$type, mode = rf_train_wo$mode,
            name = rf_train_wo$name, text = rf_train_wo$text, hoverinfo = rf_train_wo$hoverinfo,
            marker = rf_train_wo$marker, visible = rf_train_wo$visible) %>%
  layout(title = "Random Forest (Train)", shapes = list(baseline_line),
         xaxis = list(title = "Actual Revenue", range = c(0, max_axis)),
         yaxis = list(title = "Fitted Revenue", range = c(0, max_axis)))

rf_test_plot <- plot_ly() %>%
  add_trace(x = rf_test_w$x, y = rf_test_w$y, type = rf_test_w$type, mode = rf_test_w$mode,
            name = rf_test_w$name, text = rf_test_w$text, hoverinfo = rf_test_w$hoverinfo,
            marker = rf_test_w$marker, visible = rf_test_w$visible) %>%
  add_trace(x = rf_test_wo$x, y = rf_test_wo$y, type = rf_test_wo$type, mode = rf_test_wo$mode,
            name = rf_test_wo$name, text = rf_test_wo$text, hoverinfo = rf_test_wo$hoverinfo,
            marker = rf_test_wo$marker, visible = rf_test_wo$visible) %>%
  layout(title = "Random Forest (Test)", shapes = list(baseline_line),
         xaxis = list(title = "Actual Revenue", range = c(0, max_axis)),
         yaxis = list(title = "Predicted Revenue", range = c(0, max_axis)))

full_plot <- subplot(lm_plot, rf_train_plot, rf_test_plot,
                     nrows = 1, shareY = TRUE, titleX = TRUE, titleY = TRUE) %>%
  layout(
    title = list(text = "Two Models Performance: With vs Without Sentiment", y = 0.83),
    width = 900,
    height = 400,
    margin = list(t = 80),
    updatemenus = list(
      list(
        type = "buttons",
        direction = "left",
        x = 0.4, y = 1.4,
        showactive = TRUE,
        buttons = list(
          list(method = "restyle", args = list("visible", rep(c(TRUE, FALSE), 3)), label = "With Sentiment Score"),
          list(method = "restyle", args = list("visible", rep(c(FALSE, TRUE), 3)), label = "Without Sentiment Score")
        )
      )
    )
  )

full_plot
```

<div style="margin-top: 1em; font-size: 0.95em; color: #555;">
<strong>Figure:</strong> Each panel displays an interactive scatter plot with a dashed 45° reference line indicating perfect prediction. Points closer to the diagonal suggest better model performance. This visual comparison helps assess whether including sentiment information improves prediction quality.
</div>

## Importance

```{r echo=FALSE, message=FALSE, warning=FALSE}
set.seed(370)
train_index <- sample(1:nrow(movies_cleaned_box), 0.8 * nrow(movies_cleaned_box))
train_data <- movies_cleaned_box[train_index,]
test_data <- movies_cleaned_box[-train_index,]

rf_model <- randomForest(revenue ~ budget + num_production_companies + num_cast +  num_production_countries + num_genre + tmdb_rating + imdb_rating + first_genre,
                         data=train_data, ntree=100, importance=TRUE)

importance_df <- as.data.frame(importance(rf_model)) %>% 
  tibble::rownames_to_column(var = "Feature") %>%
  arrange(desc(`%IncMSE`))

var_labels <- c(
  num_cast = "Number of Casts",
  num_genre = "Number of Genres",
  num_production_companies = "Production Companies",
  num_production_countries = "Production Countries",
  budget = "Budget",
  revenue = "Revenue",
  imdb_rating = "IMDB Rating",
  imdb_votes = "IMDB Votes",
  tmdb_rating = "TMDB Rating",
  vote_count = "TMDB Vote Count",
  first_genre = "Main Genre"
)

importance_plot <- importance_df %>%
  mutate(
    Feature = ifelse(Feature %in% names(var_labels), var_labels[Feature], Feature)
  )

importance_plot$IncNodePurity <- as.numeric(importance_plot$IncNodePurity)

# === Plot for %IncMSE ===
plot_mse <- plot_ly(
  data = importance_plot,
  x = ~`%IncMSE`,
  y = ~reorder(Feature, `%IncMSE`),
  type = "bar",
  orientation = "h",
  marker = list(color = "steelblue"),
  text = ~paste("Feature:", Feature, "<br>%IncMSE:", round(`%IncMSE`, 2)),
  textposition = "none", 
  hoverinfo = "text",
  showlegend = FALSE
)

# === Plot for IncNodePurity ===
plot_purity <- plot_ly(
  data = importance_plot,
  x = ~IncNodePurity,
  y = ~reorder(Feature, IncNodePurity),
  type = "bar",
  orientation = "h",
  marker = list(color = "darkorange"),
  text = ~paste("Feature:", Feature, "<br>IncNodePurity:", round(IncNodePurity, 2)),
  textposition = "none", 
  hoverinfo = "text",
  showlegend = FALSE
)

subplot(plot_mse, plot_purity, nrows = 1, shareY = FALSE, titleX = TRUE, titleY = FALSE) %>%
  layout(
    title = list(
      text = "Random Forest Feature Importance Comparison",
      x = 0.5,
      xanchor = "center",
      font = list(size = 20)
    ),
    xaxis = list(
      title = list(text = "% Increase in MSE", standoff = 30),
      domain = c(0, 0.45)
    ),
    xaxis2 = list(
      title = list(text = "Increase in Node Purity", standoff = 30),
      domain = c(0.55, 1)
    ),
    yaxis = list(title = "", anchor = "x"),
    yaxis2 = list(title = "", anchor = "x2"),
    margin = list(t = 60),
    width = 800,
    height = 450 
  )

```


# 2. Key Insights

- Audience reviews reveal rich genre-specific language, from emotional tones to iconic keywords — showcasing how viewers engage with films through both sentiment and story.

- Family, Comedy, and Animation genres spark the most positive emotions, while darker genres like Crime and Horror trend negative — yet sentiment scores don’t significantly boost prediction accuracy.

- The full report (PDF) reveals deeper insights, including the dominant role of budget, nonlinear effects, and how genre interacts with production scale to influence box office revenue.
